<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Decodificador RAW BLE (iBeacon-like)</title>
</head>
<body>
  <h1>Decodificador RAW BLE</h1>
  <label for="raw">RAW HEX (sin espacios):</label><br>
  <textarea id="raw" rows="4" cols="80" placeholder="Ej: 0201041AFF4C0002154B57454D41323530353030303030303030303127104E218D"></textarea><br><br>
  <button onclick="decode()">Decodificar</button>

  <h2>Decodificación:</h2>
  <table border="1" cellpadding="8" id="resultTable">
    <thead>
      <tr><th>Campo</th><th>Bytes (índice)</th><th>Hex</th><th>Comentario</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    function decode() {
      let rawHex = document.getElementById("raw").value.trim().toUpperCase();
      if (rawHex.startsWith("0X")) rawHex = rawHex.slice(2);
      rawHex = rawHex.replace(/[^A-F0-9]/g, '');

      const bytes = rawHex.match(/.{2}/g)?.map((b, i) => ({
        index: i,
        value: b,
        int: parseInt(b, 16)
      }));

      const table = document.querySelector("#resultTable tbody");
      table.innerHTML = '';

      if (!bytes || bytes.length < 30) {
        alert("RAW muy corto. Se requieren al menos 30 bytes para un paquete iBeacon completo.");
        return;
      }

      function getRange(start, length) {
        return bytes.slice(start, start + length).map(b => b.value).join(' ');
      }

      function getInt16(start) {
        return (bytes[start].int << 8) | bytes[start + 1].int;
      }

      function getSignedInt8(index) {
        let val = bytes[index].int;
        return val > 127 ? val - 256 : val;
      }

      function formatUUID(start) {
        const hex = bytes.slice(start, start + 16).map(b => b.value).join('');
        return [
          hex.slice(0,8),
          hex.slice(8,12),
          hex.slice(12,16),
          hex.slice(16,20),
          hex.slice(20)
        ].join('-');
      }

      const rows = [
        ["Flags", "0-2", getRange(0, 3), ""],
        ["Longitud + Tipo", "3", getRange(3, 1), "0x1A = 26 bytes de datos"],
        ["Fabricante ID", "4-5", getRange(4, 2), bytes[4].value + bytes[5].value === "4C00" ? "Apple (0x004C)" : ""],
        ["iBeacon Tipo / Longitud", "6-7", getRange(6, 2), bytes[6].value + bytes[7].value === "0215" ? "iBeacon (0x0215)" : ""],
        ["UUID", "8-23", getRange(8, 16), `UUID: ${formatUUID(8)}`],
        ["Major", "24-25", getRange(24, 2), `Decimal: ${getInt16(24)}`],
        ["Minor", "26-27", getRange(26, 2), `Decimal: ${getInt16(26)}`],
        ["Tx Power", "28", getRange(28, 1), `Signed int8: ${getSignedInt8(28)} dBm`]
      ];

      rows.forEach(([campo, rango, hex, comentario]) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${campo}</td><td>${rango}</td><td>${hex}</td><td>${comentario}</td>`;
        table.appendChild(tr);
      });
    }
  </script>
</body>
</html>
